# projects/mexican_cooking_bot/evaluation/metrics_definition.yaml
metrics:
  - name: agent_path
    description: "The primary logical path the agent took."
    type: derive_path
    paths:
      - name: recipe_path
        if_field_exists: shopping_list
      - name: clarification_path
        if_field_exists: clarification_question
      - name: unknown_path

  - name: ingredient_count_identified
    description: "Total number of ingredients the agent extracted from the user's request."
    type: count
    field: ingredients_list
  
  - name: more_than_3
    description: "Any ingredients which are more than $3"
    type: where(> 0.5)
    field: store_search_results.price


  - name: ingredient_find_rate_percent
    description: "% of identified ingredients that were successfully found."
    type: ratio
    numerator:
      type: distinct | count
      field: store_search_results.ingredient
    denominator:
      type: count
      field: ingredients_list
    options:
      format_as_percent: true
      on_zero_denominator: 100.0

# ==============================================================================
# Assertions: Objective, pass/fail checks for every run.
# If any of these fail, the run is considered a critical failure.
# ==============================================================================
assertions:
  - name: "Must produce a primary output"
    description: "Checks that the agent produced either a shopping list or a clarification."
    # This checks that AT LEAST ONE of the fields in the list exists and is not empty.
    type: must_exist_one_of
    fields: [shopping_list, clarification_question]

  - name: "Intent must match the final output"
    description: "Ensures the agent's final action is consistent with its initial intent."
    type: fields_must_be_consistent
    # This is a list of conditional rules.
    conditions:
      - if:
          field: intent
          equals: "recipe_request"
        then:
          field: shopping_list
          must_exist: true
      - if:
          field: intent
          equals: "ambiguous"
        then:
          field: clarification_question
          must_exist: true
      - if:
          field: intent
          equals: "off_topic"
        then:
          field: clarification_question
          must_exist: true