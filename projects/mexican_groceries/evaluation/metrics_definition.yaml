# projects/mexican_cooking_bot/evaluation/metrics_definition.yaml
metrics:
  - name: agent_path
    description: "The primary logical path the agent took."
    type: derive_path
    paths:
      - name: recipe_path
        if_field_exists: shopping_list
      - name: clarification_path
        if_field_exists: clarification_question
      - name: unknown_path

  - name: ingredient_count_identified
    description: "Total number of ingredients the agent extracted from the user's request."
    type: count
    field: ingredients_list
  
  - name: more_than_3
    description: "Any ingredients which are more than $3"
    type: where(> 0.5)
    field: store_search_results.price


  - name: ingredient_find_rate_percent
    description: "% of identified ingredients that were successfully found."
    type: ratio
    numerator:
      type: distinct | count
      field: store_search_results.ingredient
    denominator:
      type: count
      field: ingredients_list
    options:
      format_as_percent: true
      on_zero_denominator: 100.0

# ==============================================================================
# Assertions: Objective, pass/fail checks for every run.
# If any of these fail, the run is considered a critical failure.
# ==============================================================================
assertions:
  - name: "Intent must be valid and initial state clean"
    # This check should run right after the intent is classified.
    stage: post_intent_classification
    description: "Ensures the intent is valid and no outputs exist yet."
    type: fields_must_be_consistent
    conditions:
      - if: # This condition is always true, so this check always runs for this stage
          field: intent 
          exists: true
        then:
          # Check that the intent value is one of our allowed types
          field: intent
          is_in: ["recipe_request", "ambiguous", "off_topic"]
      - if: # Another check for this stage
          field: intent
          exists: true
        then:
          # At this early stage, there should be NO shopping list
          field: shopping_list
          must_not_exist: true

  - name: "Must produce a primary output"
    # This check should run at the very end of the process.
    stage: final_check
    description: "Checks that the agent produced either a shopping list or a clarification."
    type: must_exist_one_of
    fields: [shopping_list, clarification_question]

  - name: "Intent must match the final output"
    # This check also runs at the end.
    stage: final_check
    description: "Ensures the agent's final action is consistent with its initial intent."
    type: fields_must_be_consistent
    conditions:
      - if:
          field: intent
          equals: "recipe_request"
        then:
          field: shopping_list
          must_exist: true
      - if:
          field: intent
          equals: "ambiguous"
        then:
          field: clarification_question
          must_exist: true